0. Create a project without LimitRange

```
PROJECT=test-vpa-uc2-$RANDOM
```

```
oc new-project $PROJECT
```

1. Delete any preexistent LimitRange.

```
oc -n $PROJECT delete limitrange --all
```

2. Deploy stress application:

```
cat <<EOF | oc -n $PROJECT apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stress
spec:
  selector:
    matchLabels:
      app: stress
  replicas: 1
  template:
    metadata:
      labels:
        app: stress
    spec:
      containers:
      - name: stress
        image: polinux/stress
        resources:
          requests:
            memory: "100Mi"
          limits:
            memory: "200Mi"
        command: ["stress"]
        args: ["--vm", "1", "--vm-bytes", "150M"]
EOF
```


3. Check that the request and limits generated in Pod

```
oc get pod -l app=stress -o yaml | grep limit -A1
        limits:
          cpu: 200m
          memory: 75Mi
```

```
oc get pod -l app=stress -o yaml | grep requests -A1
        requests:
          cpu: 100m
          memory: 50Mi
```

4. Apply the VPA 

```
cat <<EOF | oc -n $PROJECT apply -f -
apiVersion: "autoscaling.k8s.io/v1"
kind: VerticalPodAutoscaler
metadata:
  name: stress-vpa
spec:
  # recommenders field can be unset when using the default recommender.
  # When using an alternative recommender, the alternative recommender's name
  # can be specified as the following in a list.
  # recommenders: 
  #   - name: 'alternative'
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: stress
  resourcePolicy:
    containerPolicies:
      - containerName: '*'
        minAllowed:
          cpu: 100m
          memory: 50Mi
        maxAllowed:
          cpu: 1000m
          memory: 1024Mi
        controlledResources: ["cpu", "memory"]
EOF
```

NOTE: we're setting the maxAllowed higher than the potential LimitRange, to see that the LimitRange max will cap/override the expected result.



3. OOMkilled generated by the stress image pods, because it's requesting 250Mi and the limits and requests (1:1 ratio) are only 100Mi: 

```
oc get pod
NAME                     READY   STATUS      RESTARTS   AGE
stress-d65cdb98f-dwh9l   0/1     OOMKilled   0          6s
```

5. Check the VPA resources applied:

```
oc get vpa 
NAME          MODE   CPU    MEM       PROVIDED   AGE
hamster-vpa   Auto   247m   262144k   True       3m44s

oc get vpa hamster-vpa -o jsonpath='{.status}' | jq -r .
{
  "conditions": [
    {
      "lastTransitionTime": "2021-12-20T10:54:41Z",
      "status": "True",
      "type": "RecommendationProvided"
    }
  ],
  "recommendation": {
    "containerRecommendations": [
      {
        "containerName": "hamster",
        "lowerBound": {
          "cpu": "100m",
          "memory": "262144k"
        },
        "target": {
          "cpu": "247m",
          "memory": "262144k"
        },
        "uncappedTarget": {
          "cpu": "247m",
          "memory": "262144k"
        },
        "upperBound": {
          "cpu": "2",
          "memory": "2Gi"
        }
      }
    ]
  }
}
```

6. Check the VPA resources:

```
oc get pod -l app=hamster -o yaml | grep vpa
      vpaObservedContainers: hamster
      vpaUpdates: 'Pod resources updated by hamster-vpa: container 0: cpu request,
    namespace: test-vpa-2
      vpaObservedContainers: hamster
      vpaUpdates: 'Pod resources updated by hamster-vpa: container 0: memory request,
    namespace: test-vpa-2
```

7. Check that the VPA changed automatically the requests and limits in the POD, but NOT in the deployment or replicaset:

```
oc get pod -l app=hamster -o yaml | grep requests -A2
        requests:
          cpu: 143m
          memory: 262144k
--
        requests:
          cpu: 143m
          memory: 262144k
```

```
oc get pod -l app=hamster -o yaml | grep limit -A2
        memory request, cpu limit, memory limit'
    creationTimestamp: "2021-12-20T10:55:41Z"
    generateName: hamster-69df47984f-
--
        limits:
          cpu: 286m
          memory: 375Mi
--
        cpu request, cpu limit, memory limit'
    creationTimestamp: "2021-12-20T10:54:41Z"
    generateName: hamster-69df47984f-
--
        limits:
          cpu: 286m
          memory: 375Mi
```

8. The deployment of hamster app is not changed at all, the VPA just is changing the Pod spec definition:

```
oc get deployment hamster -o yaml | egrep -i 'limits|request' -A2          
          limits:
            cpu: 200m
            memory: 75Mi
          requests:
            cpu: 100m
            memory: 50Mi
```

9. Define a LimitRange for capp / limit the maximum values:

```
kind: LimitRange
apiVersion: v1
metadata:
  name: test-vpa-2-limit-range
  namespace: test-vpa-2
spec:
  limits:
    - type: Container
      max:
        cpu: '750m'
        memory: 1Gi
      default:
        cpu: 250m
        memory: 1024Mi
      defaultRequest:
        cpu: 50m
        memory: 256Mi
    - type: Pod
      max:
        cpu: '750m'
        memory: 1Gi
```

10. The HPA adjust toward the max limit defined in the LimitRange, never will override this value, it's the higher "physical" limit:

```
oc get vpa hamster-vpa -o jsonpath='{.status}' | jq -r .
{
  "conditions": [
    {
      "lastTransitionTime": "2021-12-20T10:54:41Z",
      "status": "True",
      "type": "RecommendationProvided"
    }
  ],
  "recommendation": {
    "containerRecommendations": [
      {
        "containerName": "hamster",
        "lowerBound": {
          "cpu": "312m",
          "memory": "262144k"
        },
        "target": {
          "cpu": "548m",
          "memory": "262144k"
        },
        "uncappedTarget": {
          "cpu": "548m",
          "memory": "262144k"
        },
        "upperBound": {
          "cpu": "2",
          "memory": "673899999"
        }
      }
    ]
  }
}
```
